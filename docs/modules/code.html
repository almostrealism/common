<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR-Code Module - Almost Realism Framework</title>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        .key-concepts { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 20px 0; }
        .concept-card { background: #f8f9fa; border-left: 4px solid #e65100; padding: 15px; border-radius: 4px; }
        .concept-card h4 { margin-top: 0; color: #e65100; }
        .performance-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        .performance-table th, .performance-table td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        .performance-table th { background-color: #fff3e0; color: #e65100; font-weight: bold; }
        .performance-table tr:hover { background-color: #f5f5f5; }
        .comparison-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        .comparison-table th, .comparison-table td { padding: 10px; border: 1px solid #ddd; text-align: left; }
        .comparison-table th { background-color: #fff3e0; color: #e65100; }
        .class-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; margin: 20px 0; }
        .class-item { background: #fff; border: 1px solid #ddd; padding: 12px; border-radius: 4px; }
        .class-item h4 { margin: 0 0 8px 0; color: #e65100; font-size: 1.1em; }
        .class-item p { margin: 0; font-size: 0.9em; color: #666; }
        .code-example { background: #f5f5f5; border-left: 4px solid #e65100; padding: 15px; margin: 15px 0; border-radius: 4px; }
        .highlight { background-color: #fff9c4; padding: 2px 4px; }
        .warning { background-color: #ffebee; border-left: 4px solid #c62828; padding: 12px; margin: 15px 0; }
        .package-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        .package-table th, .package-table td { padding: 10px; border: 1px solid #ddd; text-align: left; }
        .package-table th { background-color: #fff3e0; color: #e65100; }
        .package-table td:first-child { font-family: monospace; font-size: 0.9em; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>AR-Code Module</h1>
            <p class="tagline">Expression Trees, Scope Management & Code Generation</p>
            <nav>
                <a href="../index.html">Home</a>
                <a href="#overview">Overview</a>
                <a href="#architecture">Architecture</a>
                <a href="#concepts">Core Concepts</a>
                <a href="#examples">Examples</a>
                <a href="#resources">Resources</a>
            </nav>
        </header>

        <main>
            <section id="overview">
                <h2>Overview</h2>
                <p>The <strong>ar-code</strong> module provides core code generation, expression building, and traversal abstractions for the Almost Realism computational framework. It is the foundation for dynamic code generation and computation graph construction across all backend targets (OpenCL, Metal, JNI).</p>

                <div class="key-concepts">
                    <div class="concept-card">
                        <h4>Expression System</h4>
                        <p>Typed expression trees for mathematical and logical operations. Supports arithmetic, trigonometric, comparison, and conditional expressions with automatic simplification.</p>
                    </div>
                    <div class="concept-card">
                        <h4>Scope Management</h4>
                        <p>Hierarchical code organization for generated programs. Manages variables, statements, and nested scopes for structured code output.</p>
                    </div>
                    <div class="concept-card">
                        <h4>TraversalPolicy</h4>
                        <p>Multi-dimensional collection shape and traversal definitions. Supports fixed and variable-count modes for flexible data structure iteration.</p>
                    </div>
                    <div class="concept-card">
                        <h4>Code Generation</h4>
                        <p>Language-agnostic code printing and generation. Abstractions for rendering expressions and scopes to C, OpenCL, Metal, and other targets.</p>
                    </div>
                </div>
            </section>

            <section id="architecture">
                <h2>Module Architecture</h2>

                <h3>Package Organization</h3>
                <table class="package-table">
                    <thead>
                        <tr>
                            <th>Package</th>
                            <th>Purpose</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>io.almostrealism.code</td>
                            <td>Core computation, code generation, and expression management abstractions</td>
                        </tr>
                        <tr>
                            <td>io.almostrealism.expression</td>
                            <td>Mathematical expressions and operators (arithmetic, trigonometric, logical)</td>
                        </tr>
                        <tr>
                            <td>io.almostrealism.collect</td>
                            <td>Collection traversal policies and collection expressions</td>
                        </tr>
                        <tr>
                            <td>io.almostrealism.scope</td>
                            <td>Code scope management, variables, and statement organization</td>
                        </tr>
                        <tr>
                            <td>io.almostrealism.kernel</td>
                            <td>Kernel structure, indexing, and matrix operations</td>
                        </tr>
                        <tr>
                            <td>io.almostrealism.lang</td>
                            <td>Language operations abstractions for code generation backends</td>
                        </tr>
                        <tr>
                            <td>io.almostrealism.compute</td>
                            <td>Computation requirements and optimization strategies</td>
                        </tr>
                        <tr>
                            <td>io.almostrealism.profile</td>
                            <td>Performance profiling and operation metadata tracking</td>
                        </tr>
                        <tr>
                            <td>io.almostrealism.html</td>
                            <td>HTML and JavaScript code generation utilities</td>
                        </tr>
                        <tr>
                            <td>io.almostrealism.util</td>
                            <td>Utility classes (caching, sequences, formatting)</td>
                        </tr>
                        <tr>
                            <td>io.almostrealism.concurrent</td>
                            <td>Concurrency primitives (semaphores)</td>
                        </tr>
                    </tbody>
                </table>

                <h3>Expression Classes</h3>
                <div class="class-list">
                    <div class="class-item">
                        <h4>Expression&lt;T&gt;</h4>
                        <p>Abstract base class for all expressions. Provides simplification, code generation, and composition methods.</p>
                    </div>
                    <div class="class-item">
                        <h4>Sum / Product</h4>
                        <p>Addition and multiplication of multiple operands. Supports associative simplification.</p>
                    </div>
                    <div class="class-item">
                        <h4>Quotient / Difference</h4>
                        <p>Division and subtraction operations. Binary arithmetic expressions.</p>
                    </div>
                    <div class="class-item">
                        <h4>Sine / Cosine / Tangent</h4>
                        <p>Trigonometric function expressions. Single-operand mathematical functions.</p>
                    </div>
                    <div class="class-item">
                        <h4>Exp / Logarithm</h4>
                        <p>Exponential and logarithmic expressions. Essential for ML and signal processing.</p>
                    </div>
                    <div class="class-item">
                        <h4>Conditional</h4>
                        <p>Ternary conditional expression (condition ? then : else). Type-safe branching.</p>
                    </div>
                    <div class="class-item">
                        <h4>Equals / Greater / Less</h4>
                        <p>Comparison expressions returning boolean results. Foundation for conditionals.</p>
                    </div>
                    <div class="class-item">
                        <h4>Cast</h4>
                        <p>Type conversion expressions. Handles precision changes and type coercion.</p>
                    </div>
                </div>

                <h3>Scope Classes</h3>
                <div class="class-list">
                    <div class="class-item">
                        <h4>Scope&lt;T&gt;</h4>
                        <p>Primary container for code elements. Manages statements, variables, and nested scopes.</p>
                    </div>
                    <div class="class-item">
                        <h4>Variable&lt;T, V&gt;</h4>
                        <p>Named variable with optional expression. Tracks type, name, and assigned value.</p>
                    </div>
                    <div class="class-item">
                        <h4>ArrayVariable&lt;T&gt;</h4>
                        <p>Array-typed variable with indexing support. Handles multi-dimensional array access.</p>
                    </div>
                    <div class="class-item">
                        <h4>Argument&lt;T&gt;</h4>
                        <p>Scope argument with usage expectations. Defines function/kernel parameters.</p>
                    </div>
                    <div class="class-item">
                        <h4>Cases</h4>
                        <p>Conditional branching structure. Generates if-else chains from conditions.</p>
                    </div>
                    <div class="class-item">
                        <h4>Statement&lt;T&gt;</h4>
                        <p>Executable code statement. Represents a single line of generated code.</p>
                    </div>
                </div>

                <h3>Kernel Classes</h3>
                <div class="class-list">
                    <div class="class-item">
                        <h4>IndexSequence</h4>
                        <p>Sequence of numeric index values. Interface for accessing elements by position.</p>
                    </div>
                    <div class="class-item">
                        <h4>ArithmeticIndexSequence</h4>
                        <p>Efficient arithmetic progression. Represents sequences like 0, 1, 2, ... or 0, 2, 4, ...</p>
                    </div>
                    <div class="class-item">
                        <h4>ArrayIndexSequence</h4>
                        <p>General-purpose array-backed sequence. For arbitrary index patterns.</p>
                    </div>
                    <div class="class-item">
                        <h4>KernelStructureContext</h4>
                        <p>Context for kernel simplification. Provides scope for index and structure analysis.</p>
                    </div>
                </div>

                <h3>Code Generation Classes</h3>
                <div class="class-list">
                    <div class="class-item">
                        <h4>CodePrintWriter</h4>
                        <p>Interface for code output. Defines methods for writing expressions and statements.</p>
                    </div>
                    <div class="class-item">
                        <h4>CodePrintWriterAdapter</h4>
                        <p>Base implementation for C-like languages. Handles common syntax patterns.</p>
                    </div>
                    <div class="class-item">
                        <h4>LanguageOperations</h4>
                        <p>Language-specific expression rendering. Maps expressions to target syntax.</p>
                    </div>
                    <div class="class-item">
                        <h4>ScopeEncoder</h4>
                        <p>Scope-to-code encoding. Transforms scope structures into executable code.</p>
                    </div>
                </div>
            </section>

            <section id="concepts">
                <h2>Core Concepts</h2>

                <h3>Expression System</h3>
                <p>The expression system represents computations as typed expression trees that can be simplified, analyzed, and compiled into executable code.</p>
                <pre><code class="language-java">// Building expressions
Expression&lt;Double&gt; a = new DoubleConstant(3.14);
Expression&lt;Double&gt; b = new DoubleConstant(2.0);
Expression&lt;Double&gt; result = a.multiply(b).add(new DoubleConstant(1.0));

// Expressions can be simplified
Expression&lt;Double&gt; simplified = result.getSimplified();

// Generate code for target language
String code = result.getExpression(languageOps);</code></pre>

                <div class="code-example">
                    <strong>Expression Features:</strong><br>
                    - Automatic constant folding and simplification<br>
                    - Type-safe composition with generics<br>
                    - Language-agnostic representation<br>
                    - Support for complex mathematical functions
                </div>

                <h3>Scope System</h3>
                <p><code>Scope</code> is the container for executable code elements including statements, variables, methods, and nested scopes.</p>
                <pre><code class="language-java">// Create a scope
Scope&lt;Double&gt; scope = new Scope&lt;&gt;("myFunction", metadata);

// Add variables and statements
scope.declareDouble("x");
scope.assign(new ExpressionAssignment&lt;&gt;("x", expression));

// Generate code
CodePrintWriter writer = new CPrintWriter(...);
scope.write(writer);</code></pre>

                <h3>TraversalPolicy</h3>
                <p><code>TraversalPolicy</code> defines how a sequence of elements should be traversed to form a multidimensional collection. It specifies dimensions and traversal rates for transforming between output space (collection indices) and input space (natural element order).</p>

                <h4>Fixed vs Variable Count</h4>
                <table class="comparison-table">
                    <tr>
                        <th>Feature</th>
                        <th>Fixed-Count</th>
                        <th>Variable-Count</th>
                    </tr>
                    <tr>
                        <td>Creation</td>
                        <td><code>new TraversalPolicy(100)</code></td>
                        <td><code>new TraversalPolicy(false, false, 1)</code></td>
                    </tr>
                    <tr>
                        <td>Dimensions</td>
                        <td>Predetermined at construction</td>
                        <td>Adapts to runtime input sizes</td>
                    </tr>
                    <tr>
                        <td>Size</td>
                        <td>Cannot change at runtime</td>
                        <td>Determined by input data</td>
                    </tr>
                    <tr>
                        <td>Efficiency</td>
                        <td>Most efficient (compile-time optimization)</td>
                        <td>Slightly less efficient (runtime checks)</td>
                    </tr>
                    <tr>
                        <td>Use Case</td>
                        <td>Known-size data structures</td>
                        <td>Varying-sized collections</td>
                    </tr>
                </table>

                <pre><code class="language-java">// Fixed-count: Always processes exactly 100 elements
TraversalPolicy fixed = new TraversalPolicy(100);

// Multi-dimensional: 10x20 matrix, always 200 elements
TraversalPolicy matrix = new TraversalPolicy(10, 20);

// Variable-count: Processes N elements determined at runtime
TraversalPolicy variable = new TraversalPolicy(false, false, 1);

// Multi-dimensional with variable size
TraversalPolicy variableMatrix = new TraversalPolicy(false, false, 10, 20);</code></pre>

                <h3>Kernel and Index Sequences</h3>
                <p>The kernel package provides abstractions for parallel computation patterns.</p>
                <pre><code class="language-java">// Create an arithmetic sequence
IndexSequence seq = ArithmeticIndexSequence.of(0, 1, 100); // 0, 1, 2, ..., 99

// Generate expression for the sequence
Expression&lt;Integer&gt; expr = seq.getExpression(index);

// Create index sequences from expressions
IndexSequence evaluated = ArrayIndexSequence.of(expression, indexValues, length);</code></pre>

                <h3>Computation Framework</h3>
                <p>The computation framework provides the structure for building hardware-accelerated operations.</p>
                <pre><code class="language-java">// Implement a computation
public class MyComputation extends ComputationBase&lt;Double&gt; {
    @Override
    public Scope&lt;Double&gt; getScope(NameProvider provider) {
        Scope&lt;Double&gt; scope = new Scope&lt;&gt;("compute", getMetadata());
        // Build scope...
        return scope;
    }
}</code></pre>

                <div class="code-example">
                    <strong>Key Computation Classes:</strong><br>
                    - <code>Computation&lt;T&gt;</code> - Interface for computations that produce scopes<br>
                    - <code>ComputationBase&lt;T&gt;</code> - Abstract base with lifecycle support<br>
                    - <code>ComputableBase&lt;T&gt;</code> - Foundation for computable operations<br>
                    - <code>ScopeLifecycle</code> - Lifecycle hooks for scope preparation
                </div>
            </section>

            <section id="examples">
                <h2>Usage Examples</h2>

                <h3>Building and Simplifying Expressions</h3>
                <pre><code class="language-java">// Create complex expression
Expression&lt;Double&gt; a = new DoubleConstant(2.0);
Expression&lt;Double&gt; b = new DoubleConstant(3.0);
Expression&lt;Double&gt; c = new DoubleConstant(4.0);

// Build: a * b + a * c
Expression&lt;Double&gt; complex = a.multiply(b).add(a.multiply(c));

// Simplification may produce: a * (b + c)
Expression&lt;Double&gt; simplified = complex.getSimplified();

// Generate C code
String cCode = simplified.getExpression(cLanguageOps);
// Output: "(2.0 * (3.0 + 4.0))"</code></pre>

                <h3>Creating Collection Shapes</h3>
                <pre><code class="language-java">// 1D vector (100 elements, fixed)
TraversalPolicy vector = shape(100);

// 2D matrix (10 rows x 20 columns, fixed)
TraversalPolicy matrix = shape(10, 20);

// Reshape operations
TraversalPolicy original = shape(100);
TraversalPolicy reshaped = original.reshape(10, 10);  // 100 elements as 10x10 matrix

// Traversal along axis
TraversalPolicy row = matrix.traverse(0);  // Traverse along first axis (rows)</code></pre>

                <h3>Generating Code from Scopes</h3>
                <pre><code class="language-java">// Create a scope for a function
Scope&lt;Double&gt; scope = new Scope&lt;&gt;("computeResult", metadata);

// Declare variables
Variable&lt;Double, Expression&lt;Double&gt;&gt; x = scope.declareDouble("x");
Variable&lt;Double, Expression&lt;Double&gt;&gt; y = scope.declareDouble("y");

// Add computation
Expression&lt;Double&gt; sum = x.getExpression().add(y.getExpression());
scope.assign(new ExpressionAssignment&lt;&gt;("result", sum));

// Generate output
PrintWriter output = new PrintWriter(System.out);
CodePrintWriter writer = new CPrintWriter(output, "computeResult", Precision.FP32, true, false);
scope.write(writer);
writer.flush();</code></pre>

                <h3>Collection Expressions</h3>
                <pre><code class="language-java">// Create a collection expression
CollectionExpression collection = CollectionExpression.create(
    shape(10, 20),
    index -> someExpression.getValueAt(index)
);

// Access values by flat index
Expression&lt;Double&gt; value = collection.getValueAt(flatIndex);

// Stream all values
collection.stream().forEach(expr -> {
    // Process each expression
});</code></pre>

                <h3>Custom Computation Implementation</h3>
                <pre><code class="language-java">public class VectorAdd extends ComputationBase&lt;PackedCollection&gt; {
    private final Producer&lt;PackedCollection&gt; a;
    private final Producer&lt;PackedCollection&gt; b;

    public VectorAdd(Producer&lt;PackedCollection&gt; a, Producer&lt;PackedCollection&gt; b) {
        this.a = a;
        this.b = b;
    }

    @Override
    public Scope&lt;PackedCollection&gt; getScope(NameProvider provider) {
        Scope&lt;PackedCollection&gt; scope = new Scope&lt;&gt;("vectorAdd", getMetadata());

        // Get input expressions
        ArrayVariable&lt;Double&gt; inputA = scope.declareArray("a", a);
        ArrayVariable&lt;Double&gt; inputB = scope.declareArray("b", b);
        ArrayVariable&lt;Double&gt; output = scope.declareOutputArray("result");

        // Build addition loop
        Variable&lt;Integer, Expression&lt;Integer&gt;&gt; i = scope.declareInt("i");
        Expression&lt;Double&gt; sum = inputA.valueAt(i).add(inputB.valueAt(i));
        output.setValueAt(i, sum);

        return scope;
    }
}</code></pre>
            </section>

            <section id="resources">
                <h2>Additional Resources</h2>
                <ul>
                    <li><a href="../../code/README.md">Code Module README</a> - Comprehensive module documentation</li>
                    <li><a href="../apidocs/io/almostrealism/code/package-summary.html">JavaDoc API</a> - Complete API reference</li>
                    <li><a href="collect.html">AR-Collect Module</a> - Collection operations built on this foundation</li>
                    <li><a href="hardware.html">AR-Hardware Module</a> - Hardware acceleration using this code generation system</li>
                </ul>

                <h3>Related Modules</h3>
                <div class="class-list">
                    <div class="class-item">
                        <h4>ar-relation</h4>
                        <p>Provides <code>Computable</code>, <code>Evaluable</code>, <code>Producer</code> abstractions that this module builds upon.</p>
                    </div>
                    <div class="class-item">
                        <h4>ar-io</h4>
                        <p>Provides <code>Console</code>, <code>ConsoleFeatures</code>, and I/O utilities used by code generation.</p>
                    </div>
                    <div class="class-item">
                        <h4>ar-hardware</h4>
                        <p>Uses this module's code generation to produce OpenCL, Metal, and JNI kernels.</p>
                    </div>
                    <div class="class-item">
                        <h4>ar-collect</h4>
                        <p>Extends collection expressions with <code>PackedCollection</code> and hardware-accelerated operations.</p>
                    </div>
                </div>
            </section>
        </main>

        <footer>
            <p><a href="../index.html">&larr; Back to Framework Documentation</a></p>
            <p>&copy; 2024 Michael Murray. Licensed under the Apache License, Version 2.0.</p>
        </footer>
    </div>

    <script src="../js/docs.js"></script>
</body>
</html>
