<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR-Time Module - Almost Realism Framework</title>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        .key-concepts { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 20px 0; }
        .concept-card { background: #f8f9fa; border-left: 4px solid #2e7d32; padding: 15px; border-radius: 4px; }
        .concept-card h4 { margin-top: 0; color: #2e7d32; }
        .performance-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        .performance-table th, .performance-table td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        .performance-table th { background-color: #e8f5e9; color: #2e7d32; font-weight: bold; }
        .performance-table tr:hover { background-color: #f5f5f5; }
        .comparison-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        .comparison-table th, .comparison-table td { padding: 10px; border: 1px solid #ddd; text-align: left; }
        .comparison-table th { background-color: #e8f5e9; color: #2e7d32; }
        .class-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; margin: 20px 0; }
        .class-item { background: #fff; border: 1px solid #ddd; padding: 12px; border-radius: 4px; }
        .class-item h4 { margin: 0 0 8px 0; color: #2e7d32; font-size: 1.1em; }
        .class-item p { margin: 0; font-size: 0.9em; color: #666; }
        .code-example { background: #f5f5f5; border-left: 4px solid #2e7d32; padding: 15px; margin: 15px 0; border-radius: 4px; }
        .highlight { background-color: #fff9c4; padding: 2px 4px; }
        .warning { background-color: #ffebee; border-left: 4px solid #c62828; padding: 12px; margin: 15px 0; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>AR-Time Module</h1>
            <p class="tagline">Temporal Operations & Hardware-Accelerated Signal Processing</p>
            <nav>
                <a href="../index.html">Home</a>
                <a href="#overview">Overview</a>
                <a href="#architecture">Architecture</a>
                <a href="#classes">Key Classes</a>
                <a href="#performance">Performance</a>
                <a href="#examples">Examples</a>
            </nav>
        </header>

        <main>
            <section id="overview">
                <h2>Overview</h2>
                <p>The <strong>ar-time</strong> module provides comprehensive abstractions and hardware-accelerated computations for temporal operations, time-series data management, and signal processing. All operations can execute on GPU/OpenCL/Metal hardware for high-performance real-time processing.</p>

                <div class="key-concepts">
                    <div class="concept-card">
                        <h4>üîÑ Temporal Execution</h4>
                        <p>Tick-based sequential operations with setup/execution separation for efficient hardware acceleration. Supports lifecycle management and iteration control.</p>
                    </div>
                    <div class="concept-card">
                        <h4>üìä Time-Series Data</h4>
                        <p>CPU-based (TreeSet) and GPU-accelerated (PackedCollection) time-series with linear interpolation, purging, and 10M+ entry capacity.</p>
                    </div>
                    <div class="concept-card">
                        <h4>üéµ Signal Processing</h4>
                        <p>FFT/IFFT (radix-2/4), FIR filtering (low/high-pass), custom coefficient design, and frequency-domain operations.</p>
                    </div>
                    <div class="concept-card">
                        <h4>‚è±Ô∏è Timing Control</h4>
                        <p>Real-time timing regularization with rolling window averaging for consistent frame rates and tempo synchronization.</p>
                    </div>
                </div>
            </section>

            <section id="architecture">
                <h2>Module Architecture</h2>

                <h3>Core Abstractions</h3>
                <div class="class-list">
                    <div class="class-item">
                        <h4>Temporal</h4>
                        <p>Functional interface for tick-based execution. Foundation for all temporal operations.</p>
                    </div>
                    <div class="class-item">
                        <h4>TemporalFeatures</h4>
                        <p>Mixin interface providing factory methods for FFT, filtering, interpolation, and iteration utilities.</p>
                    </div>
                    <div class="class-item">
                        <h4>TemporalRunner</h4>
                        <p>Orchestrates setup/tick execution with optimization, flattening, and isolation controls.</p>
                    </div>
                    <div class="class-item">
                        <h4>Updatable</h4>
                        <p>Simple periodic update interface (legacy). Simpler alternative to Temporal for basic cases.</p>
                    </div>
                </div>

                <h3>Data Structures</h3>
                <div class="class-list">
                    <div class="class-item">
                        <h4>TemporalScalar</h4>
                        <p>Time-value pair (Pair subclass). Fundamental building block for time-series.</p>
                    </div>
                    <div class="class-item">
                        <h4>TimeSeries</h4>
                        <p>CPU-based time-series with TreeSet storage. Thread-safe, synchronized operations, ideal for small datasets.</p>
                    </div>
                    <div class="class-item">
                        <h4>AcceleratedTimeSeries</h4>
                        <p>GPU-accelerated time-series with 10M+ capacity. O(1) add, hardware interpolation, efficient purging.</p>
                    </div>
                    <div class="class-item">
                        <h4>TemporalList</h4>
                        <p>Synchronized collection of temporals. Execute multiple operations in lockstep.</p>
                    </div>
                    <div class="class-item">
                        <h4>Frequency</h4>
                        <p>Hz ‚Üî BPM conversions, wavelength calculations. Essential for tempo and frequency operations.</p>
                    </div>
                    <div class="class-item">
                        <h4>TimingRegularizer</h4>
                        <p>Rolling window (3 samples) timing adjustment for real-time systems. Smooths jitter, measures drift.</p>
                    </div>
                </div>

                <h3>Hardware-Accelerated Computations</h3>
                <div class="class-list">
                    <div class="class-item">
                        <h4>FourierTransform</h4>
                        <p>Radix-2/4 FFT/IFFT. Powers of 2 bins, batch processing, complex interleaved format.</p>
                    </div>
                    <div class="class-item">
                        <h4>Interpolate</h4>
                        <p>Linear interpolation with custom time/index mapping. Supports rate adjustment and sample rate conversions.</p>
                    </div>
                    <div class="class-item">
                        <h4>MultiOrderFilter</h4>
                        <p>Configurable FIR filter. Arbitrary coefficients, order 3-101+, zero-padding at boundaries.</p>
                    </div>
                    <div class="class-item">
                        <h4>AcceleratedTimeSeriesAdd</h4>
                        <p>GPU-accelerated series append. O(1) constant time, increments end cursor.</p>
                    </div>
                    <div class="class-item">
                        <h4>AcceleratedTimeSeriesPurge</h4>
                        <p>GPU-accelerated old data removal. Frequency-controlled execution, cursor-based cleanup.</p>
                    </div>
                    <div class="class-item">
                        <h4>AcceleratedTimeSeriesValueAt</h4>
                        <p>GPU interpolation (deprecated). Use Interpolate for new code.</p>
                    </div>
                </div>

                <h3>Setup/Tick Execution Pattern</h3>
                <p>The module uses a two-phase execution model optimized for hardware acceleration:</p>
                <div class="code-example">
                    <strong>Phase 1: Setup</strong> (once, expensive)<br>
                    ‚Ä¢ Compile kernels to GPU code<br>
                    ‚Ä¢ Allocate GPU memory<br>
                    ‚Ä¢ Initialize data structures<br>
                    ‚Ä¢ Build operation graph<br><br>
                    <strong>Phase 2: Tick</strong> (many times, fast)<br>
                    ‚Ä¢ Execute compiled kernel<br>
                    ‚Ä¢ No recompilation overhead<br>
                    ‚Ä¢ Efficient memory reuse<br>
                    ‚Ä¢ Optimal for iterative workloads
                </div>
            </section>

            <section id="classes">
                <h2>Key Classes Deep Dive</h2>

                <h3>AcceleratedTimeSeries</h3>
                <p>High-capacity GPU-accelerated time-series for real-time signal processing.</p>
                <ul>
                    <li><strong>Default capacity:</strong> 10,485,760 entries (10M+)</li>
                    <li><strong>Storage:</strong> PackedCollection in GPU-accessible memory</li>
                    <li><strong>Add complexity:</strong> O(1) constant time</li>
                    <li><strong>Interpolation:</strong> O(n) linear search + hardware acceleration</li>
                    <li><strong>Purge:</strong> O(n) scan with cursor adjustment (no memory free)</li>
                </ul>

                <table class="comparison-table">
                    <tr>
                        <th>Feature</th>
                        <th>TimeSeries</th>
                        <th>AcceleratedTimeSeries</th>
                    </tr>
                    <tr>
                        <td>Storage</td>
                        <td>TreeSet + HashMap</td>
                        <td>PackedCollection (GPU)</td>
                    </tr>
                    <tr>
                        <td>Max Size</td>
                        <td>Limited by heap</td>
                        <td>10M+ entries default</td>
                    </tr>
                    <tr>
                        <td>Hardware Accel</td>
                        <td>No</td>
                        <td>Yes (GPU/OpenCL/Metal)</td>
                    </tr>
                    <tr>
                        <td>add() Speed</td>
                        <td>O(log n)</td>
                        <td>O(1)</td>
                    </tr>
                    <tr>
                        <td>Thread Safety</td>
                        <td>Synchronized</td>
                        <td>Manual</td>
                    </tr>
                    <tr>
                        <td>Use Case</td>
                        <td>Small datasets, prototyping</td>
                        <td>Large-scale, real-time</td>
                    </tr>
                </table>

                <h3>FourierTransform</h3>
                <p>Radix-2/4 FFT implementation with hardware acceleration.</p>
                <ul>
                    <li><strong>Algorithm:</strong> Cooley-Tukey divide-and-conquer</li>
                    <li><strong>Bin counts:</strong> Powers of 2 (512, 1024, 2048, 4096, etc.)</li>
                    <li><strong>Data format:</strong> Complex interleaved (real, imag, real, imag, ...)</li>
                    <li><strong>Normalization:</strong> IFFT applies 1/N scaling, FFT does not</li>
                    <li><strong>Batch support:</strong> Process multiple signals in parallel</li>
                </ul>

                <h3>MultiOrderFilter</h3>
                <p>FIR filter with configurable coefficients.</p>
                <ul>
                    <li><strong>Filter types:</strong> Low-pass, high-pass, band-pass, custom</li>
                    <li><strong>Coefficient design:</strong> Hamming window, frequency sampling</li>
                    <li><strong>Order range:</strong> 3-101+ (higher = sharper cutoff, more computation)</li>
                    <li><strong>Edge handling:</strong> Zero-padding outside signal boundaries</li>
                    <li><strong>Formula:</strong> y[n] = Œ£(i=0 to order) h[i] * x[n - i + order/2]</li>
                </ul>

                <h3>TemporalRunner</h3>
                <p>Execution orchestrator with optimization controls.</p>
                <ul>
                    <li><strong>enableFlatten:</strong> Flatten operation graph (default: true)</li>
                    <li><strong>enableOptimization:</strong> Graph optimization passes (default: false)</li>
                    <li><strong>enableIsolation:</strong> Isolate operations for safety (default: false)</li>
                    <li><strong>buffer(int):</strong> Create runner with frame buffering</li>
                    <li><strong>get():</strong> Setup and execute (use once)</li>
                    <li><strong>getContinue():</strong> Execute without re-setup (use many times)</li>
                </ul>
            </section>

            <section id="performance">
                <h2>Performance Characteristics</h2>

                <h3>Hardware Acceleration Speedup</h3>
                <table class="performance-table">
                    <thead>
                        <tr>
                            <th>Operation</th>
                            <th>CPU Time</th>
                            <th>GPU Time</th>
                            <th>Speedup</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>FFT (2048 bins)</td>
                            <td>500¬µs</td>
                            <td>25¬µs</td>
                            <td>20√ó</td>
                        </tr>
                        <tr>
                            <td>Low-Pass Filter (order 40)</td>
                            <td>300¬µs</td>
                            <td>15¬µs</td>
                            <td>20√ó</td>
                        </tr>
                        <tr>
                            <td>Time-Series Add (1000 points)</td>
                            <td>10ms</td>
                            <td>0.5ms</td>
                            <td>20√ó</td>
                        </tr>
                        <tr>
                            <td>Interpolation (single query)</td>
                            <td>50¬µs</td>
                            <td>5¬µs</td>
                            <td>10√ó</td>
                        </tr>
                        <tr>
                            <td>Purge (10000 entries)</td>
                            <td>100ms</td>
                            <td>5ms</td>
                            <td>20√ó</td>
                        </tr>
                    </tbody>
                </table>

                <h3>Operation Complexity</h3>
                <ul>
                    <li><strong>AcceleratedTimeSeries.add():</strong> O(1) - Direct memory write</li>
                    <li><strong>AcceleratedTimeSeries.valueAt():</strong> O(n) - Linear search + interpolation</li>
                    <li><strong>AcceleratedTimeSeries.purge():</strong> O(n) - Scan and compact</li>
                    <li><strong>FourierTransform:</strong> O(N log N) - Fast Fourier Transform</li>
                    <li><strong>MultiOrderFilter:</strong> O(N √ó M) - N=signal length, M=filter order</li>
                    <li><strong>Interpolate:</strong> O(1) - With functional position mapping</li>
                </ul>

                <h3>Best Practices for Performance</h3>
                <ol>
                    <li><strong>Use AcceleratedTimeSeries for large datasets:</strong> Capacity up to 10M entries with GPU acceleration</li>
                    <li><strong>Prefer TimeSeries for small data:</strong> Simpler API, thread-safe, easier debugging</li>
                    <li><strong>Batch operations when possible:</strong> GPU excels at parallel processing</li>
                    <li><strong>Reuse TemporalRunner instances:</strong> Setup cost is high, execution is fast</li>
                    <li><strong>Profile before optimizing:</strong> Enable TemporalRunner.enableOptimization only if needed</li>
                    <li><strong>Use appropriate filter orders:</strong> Balance selectivity vs performance</li>
                </ol>
            </section>

            <section id="examples">
                <h2>Usage Examples</h2>

                <h3>Audio Processing Pipeline</h3>
                <pre><code class="language-java">public class AudioProcessor implements TemporalFeatures {
    private AcceleratedTimeSeries inputBuffer;
    private double sampleRate = 44100.0;

    public void process() {
        // Create large-capacity time-series
        inputBuffer = new AcceleratedTimeSeries(4096);

        // Apply low-pass filter at 5kHz
        MultiOrderFilter filtered = lowPass(
            p(inputBuffer),
            c(5000.0),      // 5kHz cutoff
            (int) sampleRate,
            40              // Filter order
        );

        // Analyze spectrum with FFT
        FourierTransform fft = fft(2048, filtered.get());
        PackedCollection<?> spectrum = fft.get().evaluate();

        // Process frequency data
        analyzeSpectrum(spectrum);
    }
}</code></pre>

                <h3>Real-Time Timing Control</h3>
                <pre><code class="language-java">// Target 60 FPS = 16.67ms per frame
TimingRegularizer regularizer = new TimingRegularizer(16_666_667L);

while (rendering) {
    long frameStart = System.nanoTime();

    renderFrame();

    long frameTime = System.nanoTime() - frameStart;
    regularizer.addMeasuredDuration(frameTime);

    long adjustment = regularizer.getTimingDifference();
    if (adjustment > 0) {
        Thread.sleep(adjustment / 1_000_000);  // Sleep to maintain 60 FPS
    }
}</code></pre>

                <h3>Temporal Iteration with Lifecycle</h3>
                <pre><code class="language-java">public class Synthesizer implements Temporal, TemporalFeatures {
    private AcceleratedTimeSeries output;

    @Override
    public Supplier<Runnable> tick() {
        return () -> () -> {
            // Generate one audio sample
            double sample = generateSample();
            output.add(new TemporalScalar(getCurrentTime(), sample));
        };
    }

    public void run() {
        output = new AcceleratedTimeSeries(44100);

        // Setup, run 1000 ticks, reset
        Supplier<Runnable> loop = iter(this, 1000, true);
        loop.get().run();
    }
}</code></pre>

                <h3>Frequency-Domain Filtering</h3>
                <pre><code class="language-java">public PackedCollection<?> frequencyDomainFilter(
        Producer<PackedCollection<?>> signal,
        int lowCutoff,
        int highCutoff) {

    // Forward FFT
    FourierTransform fft = fft(2048, signal);
    PackedCollection<?> spectrum = fft.get().evaluate();

    // Zero out unwanted frequencies
    for (int i = 0; i < lowCutoff; i++) {
        spectrum.set(2*i, 0.0);     // Real
        spectrum.set(2*i + 1, 0.0); // Imaginary
    }
    for (int i = highCutoff; i < 2048; i++) {
        spectrum.set(2*i, 0.0);
        spectrum.set(2*i + 1, 0.0);
    }

    // Inverse FFT to get filtered signal
    FourierTransform ifft = ifft(2048, c(spectrum));
    return ifft.get().evaluate();
}</code></pre>

                <h3>Custom FIR Filter Design</h3>
                <pre><code class="language-java">// Gaussian smoothing kernel
double[] coeffs = {0.06136, 0.24477, 0.38774, 0.24477, 0.06136};
PackedCollection<?> kernel = new PackedCollection<>(coeffs.length);
for (int i = 0; i < coeffs.length; i++) {
    kernel.set(i, coeffs[i]);
}

// Apply filter
MultiOrderFilter smoothing = MultiOrderFilter.create(signal, c(kernel));
PackedCollection<?> smoothed = smoothing.get().evaluate();</code></pre>
            </section>

            <section id="troubleshooting">
                <h2>Troubleshooting</h2>

                <h3>Common Issues</h3>

                <div class="warning">
                    <strong>Issue:</strong> <code>RuntimeException: AcceleratedTimeSeries is full</code><br>
                    <strong>Solution:</strong> Increase capacity when creating series, or purge old data periodically.
                </div>

                <div class="warning">
                    <strong>Issue:</strong> FFT produces unexpected results<br>
                    <strong>Solution:</strong> Ensure input is in complex format (real, imaginary pairs) and bin count is a power of 2.
                </div>

                <div class="warning">
                    <strong>Issue:</strong> Filter has no effect on signal<br>
                    <strong>Solution:</strong> Check that cutoff frequency is within Nyquist limit (&lt; sampleRate/2).
                </div>

                <div class="warning">
                    <strong>Issue:</strong> Temporal operations run slowly<br>
                    <strong>Solution:</strong> Use TemporalRunner with setup/tick separation instead of calling tick() directly.
                </div>

                <div class="warning">
                    <strong>Issue:</strong> Memory leaks when using TemporalRunner<br>
                    <strong>Solution:</strong> Call destroy() when done, or use try-with-resources if Destroyable.
                </div>
            </section>

            <section id="resources">
                <h2>Additional Resources</h2>
                <ul>
                    <li><a href="../../time/README.md">Time Module README</a> - Comprehensive module documentation</li>
                    <li><a href="../apidocs/org/almostrealism/time/package-summary.html">JavaDoc API</a> - Complete API reference</li>
                    <li><a href="../../tutorials/06-signal-processing.html">Signal Processing Tutorial</a> - Step-by-step guide</li>
                </ul>
            </section>
        </main>

        <footer>
            <p><a href="../index.html">‚Üê Back to Framework Documentation</a></p>
            <p>&copy; 2024 Michael Murray. Licensed under the Apache License, Version 2.0.</p>
        </footer>
    </div>

    <script src="../js/docs.js"></script>
</body>
</html>
